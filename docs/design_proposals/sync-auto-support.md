# Title

* Author(s): Appu Goundan (@loosebazooka)
* Design Shepherd: Tejal Desai (@tejal29), Priya Wadhwa (@priyawadhwa)
* Date: 09/17/2019
* Status: New

## Background

Currently skaffold does not support `sync` for files that are generated
during a build. For example when syncing java files to a container, one
would normally expect `.class` files to be sync'd, but skaffold is
really only aware of `.java` files in a build.

1. Why is this required?
  - We would like to support the following features
      - Skaffold can sync files that are not watched (these files are not
        considered inputs for the container builder)
      - Skaffold can sync files that are generated by a buildscript
      - Skaffold can be configured to run a custom script to when certain files change

2. If this is a redesign, what are the drawbacks of the current implementation?
  - This is not a redesign, but a new sync mode that may or may not be available
    in the skaffold.yaml directly to users. It could simply be an internal API
    that is usuable by builders like Jib.
  - This is similar to `_smart_` described in [sync-improvements](sync-improvements.md)

3. Is there any another workaround, and if so, what are its drawbacks?
  - Currently one can create a docker file that only copies specific build
    results into the container and relies on a local build to generate those
    intermediate artifacts. This requires a user to trigger a first build
    manually before docker kicks in to containerize the application. While
    it may be possible to automate this (for example: gradle --continuous), it
    is not an acceptable solution to require manual external processes for
    a build to succeed. Covered in [Hack it](#hack-it)

4. Mention related issues, if there are any.
  - This is not trying to solve the problem of dealing with a multistage
    dockerbuild. Intermediate build artifacts might still be possible to
    determine, however that would require an extra mechanism to do a partial
    docker build and sync files from a built container to a running container --
    something we do not intend to cover here.

#### Problems with current API/config
The current `sync` system has the following problems:
1. No way to trigger local external processes - for example, in jib, to build a
   container, one would run `./gradlew jib`, but to update class files so the
   system may sync them, one would only be required to run `./gradlew classes`.
2. No way to tell the system to sync non build inputs. Skaffold is
   normally only watching `.java` files for a build, in the sync case, we want
   it to watch `.java` files, trigger a partial build, and sync `.class` files
   so a remote server can pick up and reload the changes.

## Design

#### Hack it
To get close to the functionality we want, without modifying skaffold at all, a
Dockerfile which depends on java build outputs could be used, like:
```
FROM openjdk:8
COPY build/dependencies/ /app/dependencies
COPY build/classes/java/main/ /app/classes

CMD ["java", "-cp", "/app/classes:/app/dependencies/*", "hello.Application"]
```

with a skaffold sync block that looks like:
```
sync:
  manual:
    - src: "build/classes/java/main/**/*.class"
      dest: "/app/classes"
      strip: "build/classes/java/main/"
```

A user's devloop then looks like this:

1. run `./gradlew classes copyDependencies`
2. run `skaffold dev`
3. *make changes to some java file*
4. run `./gradlew classes`
5. *skaffold syncs files*

which is far from ideal.

#### Fix it?

What we might want, is an API that can accept configuration that looks like:

##### User Configuration

User's that use `auto` should expect the builder-sync to do the right thing and
will not be required to do much configuration.

Auto will only work with builders that have implemented the auto spec. We
expect at least `jib` to do this.

```yaml
build:
  artifacts:
  - image: ...
    context: jib-project
    jib: {}
    sync:
      auto: {}
```

##### Sync Api with Buidler

The builder will talk to sync component by providing it with the following data
1. A list of `generated` configs, each containing
    1. A `command` to generate files to sync
    2. A list of inputs to watch as triggers
    3. A list of syncs (src, dest) to execute after generation
2. A list of `direct` sync directives (src, dest) to execute without any script
   execution

So maybe some datastructures like (I don't really know a lot of go, so assume
this will be written in some consistent way eventually):

```
type AutoSync struct {
  generated []Generated
  direct []Direct
}

type Generated struct {
  command []String
  inputs []File
  syncables []Syncables
}

type Direct struct {
  syncables []Syncables
}

type Syncables struct {
  src String
  dest String
  strip String
}
```

###### Jib - Skaffold Sync interface

How a tool like Jib might surface the necessary information to Skaffold

I would expect to add a task like `_jibSkaffoldSyncMap` that will produce
json output for the skaffold-jib intergration to consume and forward to the sync
system. And example output might look like:

```
BEGIN JIB JSON
{
  "generated": {
    “target/classes”: "app/classes",
    "target": "dest2"
  },
  "direct": {
    "src/main/extra1": "/",
    "src/main/extra2": "/"
    ".m2/some/dep/my-dep-SNAPSHOT.jar": "app/dependencies/my-dep-SNAPSHOT.jar"
  }
}
```

perhaps jib should also tell the system what task/goals are required to build
the generated files??

```
{
  ...
  "generator-tasks": ["classes", "resources"]
  "generated": ...
}
```


### Open Issues/Questions

Please list any open questions here in the following format:

**What happens if the build definition changes?**

I'm not sure if we should just allow the user to go nuts, or if we should
explicitly disallow this, because changing the build definition might result in
a post-sync state that is broken.

** What about files that have specific permissions? **
Jib allows users to customize file permissions, for instance a file on the
container can be configured to be 0x456 or something. One option instead of
dealing with this, is to just make all sync'd files 777? Or we allow passthrough
of permissions from the build system to the sync system.

** Should we allow the user to configure the auto block? **

Perhaps the user knows something that jib doesnt, and wants to ignore some files
from synchronization. They might want to do:

```
sync:
  auto:
    ignored:
    - "src/main/jib/myExtraFilesThatBreakADeployment"
```

## Implementation plan

*TBD*

## Integration test plan

*TBD*
